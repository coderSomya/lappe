Metadata-Version: 2.4
Name: lending
Version: 0.0.1
Summary: Open Source Lending software
Author-email: Frappe Technologies Pvt Ltd <developers@frappe.io>
Requires-Python: >=3.10
Description-Content-Type: text/markdown

# Frappe Lending Operations Script

**Last Updated:** December 2024

**Location:** `/apps/lending/lending_operations_script.py`

---

## Table of Contents

1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Installation](#installation)
4. [Quick Start](#quick-start)
5. [Function Reference](#function-reference)
6. [Usage Examples](#usage-examples)
7. [Integration Guide](#integration-guide)
8. [Troubleshooting](#troubleshooting)
9. [Best Practices](#best-practices)

---

## Overview

The `lending_operations_script.py` is a comprehensive utility script for managing all lending operations in Frappe Lending. It provides a centralized interface for:

- ✅ Loan Management (Create, Update, Query)
- ✅ Loan Disbursement Operations
- ✅ Loan Repayment Processing
- ✅ Loan Demand Processing
- ✅ Interest Accrual Management
- ✅ Loan Security Management (Pledge/Unpledge)
- ✅ Loan Write-off Operations
- ✅ Loan Closure Operations
- ✅ Bank Reconciliation
- ✅ Reporting and Analytics

This script is designed to be used both:
- **Standalone:** Direct execution for batch operations
- **Integrated:** Imported as a module in other Python scripts
- **API Integration:** Used in REST API endpoints or background jobs

---

## Prerequisites

### System Requirements

- ✅ Frappe Framework installed and running
- ✅ Frappe Lending app installed
- ✅ Python 3.11+ (or Python 3.12)
- ✅ MariaDB/MySQL database connection
- ✅ Redis server running (for background jobs)

### Frappe Setup

Ensure your Frappe bench is properly configured:

```bash
# Verify Frappe is installed
bench version

# Verify Lending app is installed
bench --site your-site.localhost list-apps | grep lending

# Check site status
bench --site your-site.localhost console
```

### Required Frappe Modules

The script requires the following Frappe modules to be installed:
- `frappe` (Core framework)
- `erpnext` (Required dependency)
- `lending` (Frappe Lending app)

---

## Installation

### Step 1: Verify Script Location

The script should be located at:

```
/Users/prom3/Desktop/regal/frappe-bench/apps/lending/lending_operations_script.py
```

### Step 2: Verify Dependencies

All dependencies are part of Frappe Lending. No additional packages required.

### Step 3: Test Import

```bash
cd /Users/prom3/Desktop/regal/frappe-bench
bench --site your-site.localhost console
```

```python
import sys
sys.path.append('apps/lending')
from lending_operations_script import get_loan_details
print("✅ Script imported successfully")
exit()
```

---

## Quick Start

### Method 1: Using Frappe Console

```bash
cd /Users/prom3/Desktop/regal/frappe-bench
bench --site your-site.localhost console
```

```python
import sys
sys.path.append('apps/lending')
from lending_operations_script import *

# Get loan details
loan_details = get_loan_details("LOAN-00001")
print(loan_details)

# Process loan demands
process_loan_demands(posting_date="2024-01-01")

# Get loan summary
summary = get_loan_summary_report(company="Your Company")
print(summary)
```

### Method 2: As a Python Module

Create a new Python script:

```python
# my_lending_script.py
import sys
sys.path.append('/Users/prom3/Desktop/regal/frappe-bench/apps/lending')

import frappe
from lending_operations_script import *

# Initialize Frappe
frappe.init(site='your-site.localhost')
frappe.connect()

# Use functions
loan_details = get_loan_details("LOAN-00001")
print(loan_details)

frappe.db.close()
```

### Method 3: Direct Execution

```bash
cd /Users/prom3/Desktop/regal/frappe-bench
bench --site your-site.localhost console < apps/lending/lending_operations_script.py
```

---

## Function Reference

### Loan Management Functions

#### `create_loan_from_application(loan_application, submit=0)`

Create a Loan from a Loan Application.

**Parameters:**
- `loan_application` (str): Name of the Loan Application
- `submit` (int): Whether to submit the loan (0 = No, 1 = Yes)

**Returns:** Loan document object

**Example:**
```python
loan = create_loan_from_application("LOAN-APP-00001", submit=1)
print(f"Loan created: {loan.name}")
```

#### `get_loan_details(loan_name)`

Get comprehensive loan details.

**Parameters:**
- `loan_name` (str): Name of the Loan

**Returns:** Dictionary with loan information

**Example:**
```python
details = get_loan_details("LOAN-00001")
print(f"Status: {details['status']}")
print(f"Disbursed: {details['disbursed_amount']}")
```

#### `update_loan_status(loan_name, status)`

Update loan status.

**Parameters:**
- `loan_name` (str): Name of the Loan
- `status` (str): New status (e.g., "Active", "Closed", "Loan Closure Requested")

**Example:**
```python
update_loan_status("LOAN-00001", "Loan Closure Requested")
```

---

### Loan Disbursement Functions

#### `create_loan_disbursement(loan, disbursement_amount=0, posting_date=None, ...)`

Create and optionally submit a Loan Disbursement.

**Parameters:**
- `loan` (str): Name of the Loan
- `disbursement_amount` (float): Amount to disburse
- `posting_date` (str): Posting date (YYYY-MM-DD format)
- `disbursement_date` (str): Disbursement date
- `bank_account` (str): Bank account for disbursement
- `repayment_start_date` (str): Repayment start date
- `repayment_frequency` (str): Frequency (Monthly, Weekly, etc.)
- `submit` (int): Whether to submit (0 or 1)

**Returns:** Loan Disbursement document

**Example:**
```python
disbursement = create_loan_disbursement(
    loan="LOAN-00001",
    disbursement_amount=50000,
    posting_date="2024-01-15",
    submit=1
)
print(f"Disbursement created: {disbursement.name}")
```

#### `get_disbursement_summary(loan=None, from_date=None, to_date=None)`

Get loan disbursement summary.

**Parameters:**
- `loan` (str, optional): Filter by loan
- `from_date` (str, optional): Start date
- `to_date` (str, optional): End date

**Returns:** List of disbursement records

**Example:**
```python
disbursements = get_disbursement_summary(
    from_date="2024-01-01",
    to_date="2024-12-31"
)
for d in disbursements:
    print(f"{d['name']}: {d['disbursed_amount']}")
```

---

### Loan Repayment Functions

#### `create_loan_repayment(loan, applicant_type, applicant, loan_product, company, ...)`

Create and optionally submit a Loan Repayment.

**Parameters:**
- `loan` (str): Name of the Loan
- `applicant_type` (str): Type (Employee, Customer, Member)
- `applicant` (str): Applicant name
- `loan_product` (str): Loan product name
- `company` (str): Company name
- `loan_disbursement` (str, optional): Loan disbursement
- `amount_paid` (float): Amount to be paid
- `posting_date` (str): Posting date
- `value_date` (str): Value date
- `submit` (int): Whether to submit

**Returns:** Loan Repayment document

**Example:**
```python
repayment = create_loan_repayment(
    loan="LOAN-00001",
    applicant_type="Employee",
    applicant="EMP-00001",
    loan_product="Employee Loan",
    company="Your Company",
    amount_paid=5000,
    submit=1
)
```

#### `calculate_loan_amounts(loan, posting_date=None, payment_type="")`

Calculate loan amounts (principal, interest, etc.).

**Parameters:**
- `loan` (str): Name of the Loan
- `posting_date` (str, optional): Posting date
- `payment_type` (str, optional): Type of payment

**Returns:** Dictionary with calculated amounts

**Example:**
```python
amounts = calculate_loan_amounts("LOAN-00001", posting_date="2024-01-15")
print(f"Pending Principal: {amounts['pending_principal_amount']}")
print(f"Pending Interest: {amounts['pending_interest_amount']}")
```

#### `get_repayment_summary(loan=None, from_date=None, to_date=None)`

Get loan repayment summary.

**Example:**
```python
repayments = get_repayment_summary(
    loan="LOAN-00001",
    from_date="2024-01-01"
)
```

---

### Loan Demand Processing Functions

#### `process_loan_demands(posting_date=None, loan_product=None, loan=None)`

Process loan demands for a specific date.

**Parameters:**
- `posting_date` (str, optional): Date to process (default: today)
- `loan_product` (str, optional): Filter by loan product
- `loan` (str, optional): Filter by specific loan

**Returns:** Name of the Process Loan Demand document

**Example:**
```python
process_doc = process_loan_demands(posting_date="2024-01-01")
print(f"Processed: {process_doc}")
```

#### `get_loan_demands(loan=None, from_date=None, to_date=None, outstanding_only=True)`

Get loan demands.

**Example:**
```python
demands = get_loan_demands(
    loan="LOAN-00001",
    outstanding_only=True
)
for d in demands:
    print(f"{d['demand_type']}: {d['outstanding_amount']}")
```

---

### Interest Accrual Functions

#### `process_interest_accrual(posting_date=None, loan_product=None, loan=None, ...)`

Process loan interest accrual.

**Parameters:**
- `posting_date` (str, optional): Date for accrual
- `loan_product` (str, optional): Filter by loan product
- `loan` (str, optional): Filter by specific loan
- `accrual_type` (str): Type (default: "Regular")
- `company` (str, optional): Filter by company
- `loan_disbursement` (str, optional): Filter by disbursement

**Example:**
```python
accrual_doc = process_interest_accrual(
    posting_date="2024-01-01",
    company="Your Company"
)
```

#### `get_interest_accrual_summary(loan=None, from_date=None, to_date=None)`

Get interest accrual summary.

**Example:**
```python
accruals = get_interest_accrual_summary(
    from_date="2024-01-01",
    to_date="2024-12-31"
)
```

---

### Loan Security Management Functions

#### `create_loan_security_assignment(applicant_type, applicant, company, securities, ...)`

Create a Loan Security Assignment.

**Parameters:**
- `applicant_type` (str): Type of applicant
- `applicant` (str): Applicant name
- `company` (str): Company name
- `securities` (list): List of securities with qty
  ```python
  [
      {"loan_security": "SEC-001", "qty": 100},
      {"loan_security": "SEC-002", "qty": 50}
  ]
  ```
- `loan` (str, optional): Link to loan
- `loan_application` (str, optional): Link to loan application
- `submit` (int): Whether to submit

**Example:**
```python
assignment = create_loan_security_assignment(
    applicant_type="Employee",
    applicant="EMP-00001",
    company="Your Company",
    securities=[
        {"loan_security": "SEC-001", "qty": 100}
    ],
    submit=1
)
```

#### `unpledge_loan_security(loan=None, loan_security_assignment=None, ...)`

Unpledge loan security.

**Example:**
```python
release = unpledge_loan_security(
    loan="LOAN-00001",
    submit=1,
    approve=1
)
```

#### `get_pledged_securities(loan)`

Get pledged securities for a loan.

**Example:**
```python
securities = get_pledged_securities("LOAN-00001")
print(securities)
```

---

### Loan Write-off Functions

#### `write_off_loan(loan, company=None, posting_date=None, amount=0)`

Write off a loan.

**Parameters:**
- `loan` (str): Name of the Loan
- `company` (str, optional): Company
- `posting_date` (str, optional): Posting date
- `amount` (float): Amount to write off (0 = full amount)

**Example:**
```python
write_off = write_off_loan(
    loan="LOAN-00001",
    posting_date="2024-01-15",
    amount=5000
)
```

#### `get_write_off_summary(loan=None, from_date=None, to_date=None)`

Get loan write-off summary.

---

### Loan Closure Functions

#### `close_loan(loan)`

Close an unsecured term loan.

**Example:**
```python
close_loan("LOAN-00001")
```

#### `request_loan_closure(loan)`

Request loan closure (sets status to "Loan Closure Requested").

**Example:**
```python
request_loan_closure("LOAN-00001")
```

---

### Bank Reconciliation Functions

#### `get_bank_clearance_entries(from_date, to_date, account, ...)`

Get payment entries for bank clearance.

**Example:**
```python
entries = get_bank_clearance_entries(
    from_date="2024-01-01",
    to_date="2024-12-31",
    account="Bank Account - COMPANY"
)
```

#### `get_bank_reconciliation_statement(filters)`

Get bank reconciliation statement entries.

**Example:**
```python
filters = {
    "account": "Bank Account - COMPANY",
    "report_date": "2024-12-31"
}
entries = get_bank_reconciliation_statement(filters)
```

---

### Reporting Functions

#### `get_loan_summary_report(company=None, from_date=None, to_date=None)`

Get comprehensive loan summary report.

**Returns:** Dictionary with statistics

**Example:**
```python
summary = get_loan_summary_report(company="Your Company")
print(f"Total Loans: {summary['total_loans']}")
print(f"Active Loans: {summary['active_loans']}")
print(f"Total Disbursed: {summary['total_disbursed_amount']}")
```

#### `get_outstanding_loans(company=None)`

Get all loans with outstanding amounts.

**Example:**
```python
outstanding = get_outstanding_loans(company="Your Company")
for loan in outstanding:
    print(f"{loan['name']}: {loan['outstanding_amount']}")
```

#### `get_loan_repayment_schedule(loan)`

Get loan repayment schedule.

**Example:**
```python
schedule = get_loan_repayment_schedule("LOAN-00001")
for entry in schedule:
    print(f"{entry['payment_date']}: {entry['total_payment']}")
```

---

## Usage Examples

### Example 1: Complete Loan Lifecycle

```python
import sys
sys.path.append('apps/lending')
from lending_operations_script import *

# 1. Create loan from application
loan = create_loan_from_application("LOAN-APP-00001", submit=1)

# 2. Disburse loan
disbursement = create_loan_disbursement(
    loan=loan.name,
    disbursement_amount=50000,
    submit=1
)

# 3. Process demands
process_loan_demands(posting_date="2024-01-01")

# 4. Process interest accrual
process_interest_accrual(
    posting_date="2024-01-01",
    loan=loan.name
)

# 5. Create repayment
repayment = create_loan_repayment(
    loan=loan.name,
    applicant_type="Employee",
    applicant="EMP-00001",
    loan_product="Employee Loan",
    company="Your Company",
    amount_paid=5000,
    submit=1
)

# 6. Get loan details
details = get_loan_details(loan.name)
print(f"Outstanding: {details['disbursed_amount'] - details['total_amount_paid']}")
```

### Example 2: Batch Processing

```python
# Process demands for multiple loans
loans = ["LOAN-00001", "LOAN-00002", "LOAN-00003"]

for loan in loans:
    try:
        process_loan_demands(
            posting_date="2024-01-01",
            loan=loan
        )
        print(f"✅ Processed: {loan}")
    except Exception as e:
        print(f"❌ Error processing {loan}: {str(e)}")
```

### Example 3: Daily Scheduled Tasks

```python
from datetime import date, timedelta

# Process yesterday's demands
yesterday = (date.today() - timedelta(days=1)).strftime("%Y-%m-%d")

# Process demands
process_loan_demands(posting_date=yesterday)

# Process interest accrual
process_interest_accrual(posting_date=yesterday)

# Generate reports
summary = get_loan_summary_report()
print(f"Daily Summary: {summary}")
```

### Example 4: Security Management

```python
# Create security assignment
assignment = create_loan_security_assignment(
    applicant_type="Employee",
    applicant="EMP-00001",
    company="Your Company",
    securities=[
        {"loan_security": "SEC-001", "qty": 100},
        {"loan_security": "SEC-002", "qty": 50}
    ],
    loan="LOAN-00001",
    submit=1
)

# Get pledged securities
securities = get_pledged_securities("LOAN-00001")
print(f"Pledged: {securities}")

# Unpledge security
release = unpledge_loan_security(
    loan="LOAN-00001",
    security_map={"SEC-001": 50},  # Unpledge 50 units
    submit=1
)
```

---

## Integration Guide

### Integration with Frappe Scheduler

Create a scheduled job to run daily:

```python
# File: apps/lending/lending/scheduled_tasks.py
import frappe
from lending_operations_script import process_loan_demands, process_interest_accrual
from frappe.utils import add_days, nowdate

def daily_loan_processing():
    """Scheduled task to run daily"""
    posting_date = add_days(nowdate(), -1)  # Yesterday
    
    # Process demands
    process_loan_demands(posting_date=posting_date)
    
    # Process interest accrual
    process_interest_accrual(posting_date=posting_date)
    
    frappe.db.commit()
```

Add to `hooks.py`:

```python
scheduler_events = {
    "daily": [
        "lending.scheduled_tasks.daily_loan_processing"
    ]
}
```

### Integration with REST API

```python
# File: apps/lending/lending/api/loan_operations.py
import frappe
from frappe import _
from lending_operations_script import *

@frappe.whitelist()
def api_get_loan_details(loan_name):
    """API endpoint to get loan details"""
    try:
        return get_loan_details(loan_name)
    except Exception as e:
        frappe.throw(str(e))

@frappe.whitelist()
def api_create_repayment(loan, amount_paid, posting_date=None):
    """API endpoint to create repayment"""
    try:
        loan_doc = frappe.get_doc("Loan", loan)
        repayment = create_loan_repayment(
            loan=loan,
            applicant_type=loan_doc.applicant_type,
            applicant=loan_doc.applicant,
            loan_product=loan_doc.loan_product,
            company=loan_doc.company,
            amount_paid=amount_paid,
            posting_date=posting_date,
            submit=1
        )
        return {"status": "success", "repayment": repayment.name}
    except Exception as e:
        return {"status": "error", "message": str(e)}
```

### Integration with External Systems (LOS)

```python
# File: los_integration.py
import requests
import frappe
from lending_operations_script import *

FRAPPE_CONFIG = {
    'base_url': 'http://library.localhost:8000',
    'api_key': 'your_api_key',
    'api_secret': 'your_api_secret'
}

def sync_loan_from_los(loan_data):
    """Sync loan from LOS to Frappe"""
    
    # 1. Create/Update Company
    company = ensure_company_exists(loan_data['company'])
    
    # 2. Create/Update Employee
    employee = ensure_employee_exists(loan_data['employee'])
    
    # 3. Create Loan Application
    application = create_loan_application(loan_data)
    
    # 4. Create Loan from Application
    loan = create_loan_from_application(application.name, submit=1)
    
    # 5. Disburse if approved
    if loan_data.get('status') == 'Approved':
        create_loan_disbursement(
            loan=loan.name,
            disbursement_amount=loan_data['amount'],
            submit=1
        )
    
    return loan.name

def ensure_company_exists(company_data):
    """Ensure company exists in Frappe"""
    # Implementation here
    pass

def ensure_employee_exists(employee_data):
    """Ensure employee exists in Frappe"""
    # Implementation here
    pass
```

---

## Troubleshooting

### Issue 1: "Module not found: lending_operations_script"

**Solution:**

```bash
# Verify script location
ls -la apps/lending/lending_operations_script.py

# Add to Python path
import sys
sys.path.append('/Users/prom3/Desktop/regal/frappe-bench/apps/lending')
```

### Issue 2: "Frappe not initialized"

**Solution:**

```python
import frappe
frappe.init(site='your-site.localhost')
frappe.connect()
# Your code here
frappe.db.close()
```

### Issue 3: "Permission denied" errors

**Solution:**

```python
# Check user permissions
frappe.has_permission("Loan", "read")

# Or run as Administrator
frappe.set_user("Administrator")
```

### Issue 4: "Loan not found"

**Solution:**

```python
# Verify loan exists
loan_exists = frappe.db.exists("Loan", "LOAN-00001")
if not loan_exists:
    print("Loan does not exist")
```

### Issue 5: "Account not found" errors

**Solution:**

Ensure all required accounts are created in Chart of Accounts. See the setup guide for account creation.

---

## Best Practices

### 1. Error Handling

Always wrap operations in try-except blocks:

```python
try:
    loan = create_loan_from_application("LOAN-APP-00001", submit=1)
    print(f"✅ Loan created: {loan.name}")
except Exception as e:
    print(f"❌ Error: {str(e)}")
    frappe.log_error(f"Loan creation failed: {str(e)}")
```

### 2. Database Transactions

Always commit after operations:

```python
# After creating/updating documents
frappe.db.commit()
```

### 3. Logging

Use Frappe's logging:

```python
import frappe
frappe.log_error("Operation completed", "Lending Operations")
```

### 4. Batch Processing

For large batches, process in chunks:

```python
loans = frappe.get_all("Loan", filters={"status": "Active"})
chunk_size = 100

for i in range(0, len(loans), chunk_size):
    chunk = loans[i:i+chunk_size]
    for loan in chunk:
        process_loan_demands(loan=loan.name)
    frappe.db.commit()  # Commit after each chunk
```

### 5. Date Handling

Always use Frappe's date utilities:

```python
from frappe.utils import getdate, add_days, nowdate

posting_date = getdate("2024-01-01")
yesterday = add_days(nowdate(), -1)
```

---

## Additional Resources

- **Frappe Lending Documentation:** https://github.com/frappe/lending
- **Frappe Framework Docs:** https://frappeframework.com/docs
- **Frappe Forum:** https://discuss.frappe.io
- **Setup Guide:** See the comprehensive setup guide provided

---

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Review Frappe Lending documentation
3. Post on Frappe Forum
4. Check application logs: `logs/frappe.log`

---

**Last Updated:** December 2024  
**Script Version:** 1.0  
**Compatible with:** Frappe Lending v1.0+

